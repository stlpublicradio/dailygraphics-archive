<!DOCTYPE html>
<html lang="en">

<head>
    <title>2013-2014 Annual Performance Report</title>

    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <!-- Fonts -->
    <script src="//ajax.googleapis.com/ajax/libs/webfont/1.4.10/webfont.js"></script>
    <script>
        WebFont.load({
             custom: {
                 families: [
                     'Gotham SSm:n4,n7',
                     'Gotham:n4,n7'
                 ],
                 urls: [
                     'http://s.npr.org/templates/css/fonts/GothamSSm.css',
                     'http://s.npr.org/templates/css/fonts/Gotham.css'
                 ]
             },
             timeout: 10000
         });
    </script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>


<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css' rel='stylesheet' />

<script src="js/lib/leaflet-0.7.2/leaflet.js" type="text/javascript"></script>

 <script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.js'></script>
    
    <style type="text/css">
    @import url(http://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Titillium+Web:700,400,300);
        /* base styles */
        html { -webkit-text-size-adjust: none; }
    body {
        margin: 0;
        padding: 0;
        font: 12px/1.4 'Titillium Web', Helvetica, sans-serif;
        color: #333;
	width: 100%;
    }
    h1 {
        margin: 0 0 6px 0;
        font-size: 16px;
        color: #333;
    }
    h2 {
        font-weight: 700;
        color: #333;
        font-size: 14px;
        margin: 0;
    }
        .footnotes { margin-bottom: 20px; }
        .footnotes h4 {
            margin: 2px 0 7px 0;
            color: #666;
            font-size: 11px;
        }
        .footnotes p,
        .footer p {
            margin: 2px 0 0 0;
            font-size: 11px;
            line-height: 1.3;
            color: #808080;
        }
        a, a:link, a:visited {
            color: #4774CC;
            text-decoration: none;
        }
        a:hover, a:active { opacity: 0.7; }
	
	html,
	body,
	#map {
	    position: relative;
	    height: 575px;
	    width: 100%;
	    margin: 0;
	    padding: 0;
	}
	
	div#map {
	        font: 12px/1.4 'Titillium Web', Helvetica, sans-serif;
		
	}

	.info {
		padding: 6px 8px;
		font-size: 14px;
		background: white;
		background: rgba(255,255,255,0.8);
		box-shadow: 0 0 15px rgba(0,0,0,0.2);
		border-radius: 5px;
	}
	.info h4 {
		margin: 0 0 5px;
		color: #777;
	}

	.legend {
		text-align: left;
		line-height: 18px;
		color: #555;
	}
	.legend i {
		min-width: 20px;
		max-width: 20%;
		height: 18px;
		float: left;
		margin-right: 8px;
		opacity: 0.7;
	}
        /* table */
        table {
            border-collapse: collapse;
            padding: 0;
            margin: 0 0 22px 0;
            width: 100%;
            font-size: 12px;
        }
        table th {
            text-align: left;
            border-bottom: 2px solid #eee;
            vertical-align: bottom;
        }
        table td {
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        table th,
        table td {
            padding: 10px;
            color: #333;
            text-align: center;
        }
        table th:nth-child(1),
        table td:nth-child(1) {
            text-align: left;
            font-weight: bold;
        }
	
	table tr.color-rank-0 {
		background-color: #d7191c;
	}
	
	table tr.color-rank-1 {
		background-color: #fdae61;
	}
	
	table tr.color-rank-2 {
		background-color: #ffffbf;
	}
	
	table tr.color-rank-3 {
		background-color: #a6d96a;
	}
	
	table tr.color-rank-4 {
		background-color: #1a9641;
	}
	

        /* responsive table */
        @media screen and (max-width: 480px) {
            table,
            tbody {
                display: block;
                width: 100%;
            }
            thead { display: none; }
            table tr,
            table th,
            table td {
                display: block;
                padding: 0;
                text-align: left;
                white-space: normal;
            }
            table td { 
                border: none;
                margin-bottom: 6px;
                color: #444;
            }
            table td:empty { display: none; }

            table tr {
                border-bottom: 1px solid #eee;
                padding-bottom: 11px;
                margin-bottom: 11px;
            }
            table th[data-title]:before,
            table td[data-title]:before {
                content: attr(data-title) ":\00A0";
                font-weight: bold;
            }

            table tr td:first-child { 
                font-size: 14px;
                font-weight: bold;
                margin-bottom: 6px;
                color: #333;
            }
            table tr td:first-child:before {
                content: '';
            }
        }
	
	div#table1 {
		height: 200px;
		overflow-y: scroll;
	}
    </style>

</head>
<body>
    {% if COPY.labels.headline %}<h1>{{ COPY.labels.headline }}</h1>{% endif %}
    {% if COPY.labels.subhed %}<h2>{{ COPY.labels.subhed }}</h2>{% endif %}
	{% if COPY.labels.intro %}<p>{{ COPY.labels.intro }}</p>{% endif %}
    <div id="graphic">
    	<div id="map">
	</div>
	{% if COPY.labels.table1text %}
	<div id="table1text">
		<p>{{ COPY.labels.table1text }}</p>
	</div>
	{% endif %}
	<div id="table1">
		<table>
			<thead>
				<tr>
					<th>{{ COPY.labels.hdr_district }}</th>
					<th>{{ COPY.labels.hdr_2013 }}</th>
					<th>{{ COPY.labels.hdr_2013_pct }}</th>
					<th>{{ COPY.labels.hdr_2014 }}</th>
					<th>{{ COPY.labels.hdr_2014_pct }}</th>
					<th>{{ COPY.labels.hdr_pct_chg }}</th>
				</tr>
			</thead>
			
			{% for row in COPY.data %}
			<tr {% if row.color_rank %}class="color-rank-{{ row.color_rank }}"{% endif %}>
				<td data-title="{{ COPY.labels.hdr_district }}">{{ row.district }}</td>
				<td data-title="2013points">{% if row.earned_2013 %}{{ row.earned_2013 }}{% endif %}/{% if row.poss_2013 %}{{ row.poss_2013 }}{% endif %}</td>
				<td data-title="2013pct">{% if row.pct_2013 %}{{ row.pct_2013 }}%{% endif %}</td>
				<td data-title="2014points">{% if row.earned_2014 %}{{ row.earned_2014 }}{% endif %}/{% if row.poss_2014 %}{{ row.poss_2014 }}{% endif %}</td>
				<td data-title="2014pct">{% if row.pct_2014 %}{{ row.pct_2014 }}%{% endif %}</td>
				<td data-title="pctchg">{% if row.pct_chg %}{{ row.pct_chg }}{% endif %}</td>
			</tr>
			{% endfor %}
		</table>
	</div>
		<hr>
	{% if COPY.labels.table2heading %}
	<h2>{{ COPY.labels.table2heading }}</h2>
	{% endif %}
	{% if COPY.labels.table2text %}
	<p>{{ COPY.labels.table2text }}</p>
	{% endif %}
	
	<div id="table2">
		<table>
			<thead>
				<tr>
					<th>{{ COPY.labels.hdr_2_dist }}</th>
					<th>{{ COPY.labels.hdr_2_total }}</th>
					<th>{{ COPY.labels.hdr_2_without }}</th>
					<th>{{ COPY.labels.hdr_2_diff }}</th>
				</tr>
			</thead>
			
			{% for row in COPY.transfers %}
			<tr>
				<td data-title="{{ COPY.labels.hdr_2_dist }}">{{ row.district }}</td>
				<td data-title="{{ COPY.labels.hdr_2_total }}">{{ row.points_earned }} ({{ row.pct_earned }}%)</td>
				<td data-title="{{ COPY.labels.hdr_2_without }}">{{ row.non_transfer_pts }} ({{ row.non_transfer_pct }}%)</td>
				<td data-title="{{ COPY.labels.hdr_2_diff }}">{{ row.diff }}</td>
			</tr>
			{% endfor %}
		</table>
	</div>
    </div>
    
    {% if COPY.labels.footnote %}
    <div class="footnotes">
        <h4>Notes</h4>
        <p>{{ COPY.labels.footnote }}</p>
    </div>
    {% endif %}

    <div class="footer">
        {% if COPY.labels.source %}<p>Source: {{ COPY.labels.source }}</p>{% endif %}
        {% if COPY.labels.credit %}<p>Credit: {{ COPY.labels.credit }}</p>{% endif %}
    </div>
    
    <script type="text/javascript" src="dist-data.js"></script>

    <script type="text/javascript">

    var northEast = L.latLng(44.878, -78.231),
        southWest = L.latLng(30.78, -106.122),
        bounds = L.latLngBounds(southWest, northEast);

    var map = L.map('map').setView([38.642618 , -90.922852], 9).setMaxBounds(bounds);

    var tiles = L.mapbox.tileLayer('brentajones.hgag33mf', {
    attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
}).addTo(map);
    
    var info = L.control();

    info.onAdd = function (map) {
    	this._div = L.DomUtil.create('div', 'info');
    	this.update();
    	return this._div;
    };

    info.update = function (props) {
	    	    
    	this._div.innerHTML = '<h4>APR reports, 2013-2014</h4>' +  
	(props ?
    		'<b>' +
		props.NAME +
		'</b><br /><b>2013:</b> Earned ' +
		props.data_2013_earn +
		' points out of a possible ' +
		props.data_2013_poss +
		' (' +
		d3.round(((props.data_2013_earn / props.data_2013_poss)*100)) +
		'%)<br /><b>2014:</b> Earned ' +
		props.data_2014_earn +
		' points out of a possible ' +
		props.data_2014_poss +
		' (' +
		d3.round(((props.data_2014_earn / props.data_2014_poss)*100)) +
		'%)<br />That\'s ' +
			((((props.data_2014_earn / props.data_2014_poss)*100) - ((props.data_2013_earn / props.data_2013_poss)*100)) > 0 ?
			'an increase of ' +
			d3.round(((props.data_2014_earn / props.data_2014_poss)*100) - ((props.data_2013_earn / props.data_2013_poss)*100), 2) +
			' percentage points' :
				((((props.data_2014_earn / props.data_2014_poss)*100) - ((props.data_2013_earn / props.data_2013_poss)*100)) == 0 ?
				'no change from 2013 to 2014.' :
				'a decrease of ' +
				Math.abs(d3.round(((props.data_2014_earn / props.data_2014_poss)*100) - ((props.data_2013_earn / props.data_2013_poss)*100), 2)) +
				' percentage points'))
	: 'Hover over a district');
    };

    info.addTo(map);
    
    function getColor(d) {
    	return d > 10  ? '#1a9641' :
    	       d > 1  ? '#a6d96a' :
    	       d > -1  ? '#ffffbf' :
    	       d > -10  ? '#fdae61' :
    	       d > -100   ? '#d7191c' :
    	                 '#000000';
    }
    
    function style(feature) {
	    var earn_2013 = feature.properties.data_2013_earn,
	    poss_2013 = feature.properties.data_2013_poss,
	    earn_2014 = feature.properties.data_2014_earn,
	    poss_2014 = feature.properties.data_2014_poss,
	    pct_2013 = ((earn_2013/poss_2013)*100),
	    pct_2014 = ((earn_2014/poss_2014)*100),
	    pct = pct_2014 - pct_2013;
	    
	
	return {
    		weight: 1,
    		opacity: .6,
    		color: '#eee',
    		fillOpacity: 0.6,
    		fillColor: getColor(pct)
    		};
    	}
		
	function highlightFeature(e) {
    			var layer = e.target;

    			layer.setStyle({
    				weight: 5,
    				color: '#666',
    				dashArray: '',
    				fillOpacity: 1
    			});

    			if (!L.Browser.ie && !L.Browser.opera) {
    				layer.bringToFront();
    			}

    			info.update(layer.feature.properties);
    		}

    		var geojson;

    		function resetHighlight(e) {
    			geojson.resetStyle(e.target);
    			// info.update();
    		}

    		function zoomToFeature(e) {
    			map.fitBounds(e.target.getBounds());
    		}

    		function onEachFeature(feature, layer) {
    			layer.on({
    				mouseover: highlightFeature,
    				mouseout: resetHighlight,
    				click: zoomToFeature
    			});
    		}		

    var geojson;

    geojson = L.geoJson(distData, {
    	style: style,
    	onEachFeature: onEachFeature
    }).addTo(map);

    var legend = L.control({position: 'bottomright'});

    legend.onAdd = function (map) {

    	var div = L.DomUtil.create('div', 'info legend'),
    		grades = [-100, -10, -1, 1, 10],
		text = ['Decrease of more than 10 percentage points', 'Decrease of 1 to 10 percentage points','Change of less than 1 percentage point', 'Increase of 1 to 10 percentage points', 'Increase of more than 10 percentage points']
    		labels = [];

    	for (var i = 0; i < grades.length; i++) {
    		from = grades[i];
    		to = grades[i + 1];

    		labels.push(
    			'<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
			text[i] );
    	}

    	div.innerHTML = labels.join('<br>');
    	return div;
    };

    legend.addTo(map);

    </script>

    <script src="js/lib/jquery.js" type="text/javascript"></script>
    <script src="js/lib/pym.js" type="text/javascript"></script>
    <script src="js/graphic.js" type="text/javascript"></script>
</body>
</html>
