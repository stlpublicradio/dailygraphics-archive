<!DOCTYPE html>
<html lang="en">

<head>
    <title>2014 primary election results</title>

    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" type="text/css" href="style.css">
    <!-- Fonts -->
</head>
<body>
	<p class="small"><em>Results as of midnight 2014-08-06 with 100% precincts reporting.</em></p><p><em>Hover over any county to see the current margin of victory (or if negative, margin of loss).</em></p>
	<h1>Amendment 1</h1>
	<p>Right to farm</p>
	<h2>NO: <span class="no1"></span></h2>
	<h2>YES: <span class="yes1"></span></h2>
	<p class="analysis">While the margin of victory for the "right to farm" was narrow, the results show the deep rural-urban split in the state, with the more populated urban areas of Kansas City, Springfield, Columbia and St. Louis all coming out strongly against <a href="http://news.stlpublicradio.org/post/st-louis-county-could-determine-outcome-right-farm" target="_parent">Amendment 1.</a></p>
	<svg class="amendment1"></svg>
	<div class="legend">
		<div class="even">Dead heat</div>
		<div class="lo1">Losing by less than 100 votes</div>
		<div class="lo2">Losing by 100-499 votes </div>
		<div class="lo3">Losing by 500-999 votes</div>
		<div class="lo4">Losing by 1,000 or more votes</div>
		<div class="noinfo">No data</div>
		<div class="hi1">Winning by less than 100 votes</div>
		<div class="hi2">Winning by 100-499 votes</div>
		<div class="hi3">Winning by 500-999 votes</div>
		<div class="hi4">Winning by 1,000 or more votes</div>
	</div>
	<div class="spacer"></div>
	<h1>Amendment 5</h1>
	<p>Keep and bear arms</p>
	<h2>NO: <span class="no5"></span></h2>
	<h2>YES: <span class="yes5"></span></h2>
	<p class="analysis">
		Support for <a href="http://news.stlpublicradio.org/post/amendment-5-would-expand-gun-rights-missouri" target="_parent">gun rights</a> is deeply embedded in the culture of the state among both Republicans and rural Democrats, with the exception of the liberal urban areas of Columbia and St. Louis.
	</p>
	<svg class="amendment5"></svg>
	<div class="legend">
		<div class="even">Dead heat</div>
		<div class="lo1">Losing by less than 100 votes</div>
		<div class="lo2">Losing by 100-499 votes </div>
		<div class="lo3">Losing by 500-999 votes</div>
		<div class="lo4">Losing by 1,000 or more votes</div>
		<div class="noinfo">No data</div>
		<div class="hi1">Winning by less than 100 votes</div>
		<div class="hi2">Winning by 100-499 votes</div>
		<div class="hi3">Winning by 500-999 votes</div>
		<div class="hi4">Winning by 1,000 or more votes</div>
	</div>
	<div class="spacer"></div>
	<h1>Amendment 7</h1>
	<p>Transportation tax</p>
	<h2>NO: <span class="no7"></span></h2>
	<h2>YES: <span class="yes7"></span></h2>
	<p class="analysis">Despite a very well-funded campaign for the tax, opposition to an <a href="http://news.stlpublicradio.org/post/well-financed-transportation-tax-loses-big-polls" target="_parent">increase in the sales tax</a> was widespread throughout the state, even in many rural areas, where road and bridge projects are generally popular.
	</p>
	<svg class="amendment7"></svg>
	<div class="legend">
		<div class="even">Dead heat</div>
		<div class="lo1">Losing by less than 100 votes</div>
		<div class="lo2">Losing by 100-499 votes </div>
		<div class="lo3">Losing by 500-999 votes</div>
		<div class="lo4">Losing by 1,000 or more votes</div>
		<div class="noinfo">No data</div>
		<div class="hi1">Winning by less than 100 votes</div>
		<div class="hi2">Winning by 100-499 votes</div>
		<div class="hi3">Winning by 500-999 votes</div>
		<div class="hi4">Winning by 1,000 or more votes</div>
	</div>
	<div class="spacer"></div>
	<h1>Amendment 8</h1>
	<p>Veterans lottery ticket</p>
	<h2>NO: <span class="no8"></span></h2>
	<h2>YES: <span class="yes8"></span></h2>
	<p class="analysis">
		No active campaign for or against a <a href="http://news.stlpublicradio.org/post/missouri-voters-decide-privacy-protection-veterans-lottery-ticket" target="_parent">veterans lottery ticket</a> was waged, but it appears that especially in the cities, voters were concerned that a new lottery ticket would reduce the amount of lottery proceeds for education.
	</p>
	<svg class="amendment8"></svg>
	<div class="legend">
		<div class="even">Dead heat</div>
		<div class="lo1">Losing by less than 100 votes</div>
		<div class="lo2">Losing by 100-499 votes </div>
		<div class="lo3">Losing by 500-999 votes</div>
		<div class="lo4">Losing by 1,000 or more votes</div>
		<div class="noinfo">No data</div>
		<div class="hi1">Winning by less than 100 votes</div>
		<div class="hi2">Winning by 100-499 votes</div>
		<div class="hi3">Winning by 500-999 votes</div>
		<div class="hi4">Winning by 1,000 or more votes</div>
	</div>
	<div class="spacer"></div>
	<h1>Amendment 9</h1>
	<p>Electronic privacy</p>
	<h2>NO: <span class="no9"></span></h2>
	<h2>YES: <span class="yes9"></span></h2>
	<p class="analysis">
		In the wake of the controversy over NSA surveillance, an unusual coalition of conservatives and liberals, including the ACLU, found common ground in their support for <a href="http://news.stlpublicradio.org/post/missouri-voters-decide-privacy-protection-veterans-lottery-ticket" target="_parent">protecting electronic communications</a>.
	</p>
	<svg class="amendment9"></svg>
	<div class="legend">
		<div class="even">Dead heat</div>
		<div class="lo1">Losing by less than 100 votes</div>
		<div class="lo2">Losing by 100-499 votes </div>
		<div class="lo3">Losing by 500-999 votes</div>
		<div class="lo4">Losing by 1,000 or more votes</div>
		<div class="noinfo">No data</div>
		<div class="hi1">Winning by less than 100 votes</div>
		<div class="hi2">Winning by 100-499 votes</div>
		<div class="hi3">Winning by 500-999 votes</div>
		<div class="hi4">Winning by 1,000 or more votes</div>
	</div>
	<div class="countyexec">
		<h1>St. Louis County Executive race</h1>
			<p class="small"><em>Results as of 11:11 p.m. 2014-08-05 with 100% of precincts reporting.</em></p>
		<div class="stldem">
			<h3>Democrat</h3>
		</div>
		<div class="stlrep">
			<h3>Republican</h3>
		</div>
	</div>
	
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<style>

	</style>
	<script>
	var width = 570,
	    height = 570;

	var svg1 = d3.select(".amendment1")
		.attr("width", width)
	    .attr("height", height);

	var svg5 = d3.select(".amendment5")
		.attr("width", width)
	    .attr("height", height);
			
	var svg7 = d3.select(".amendment7")
		.attr("width", width)
	    .attr("height", height);
			
	var svg8 = d3.select(".amendment8")
		.attr("width", width)
		.attr("height", height);

	var svg9 = d3.select(".amendment9")
		.attr("width", width)
		.attr("height", height);

	var projection = d3.geo.transverseMercator()
	    .rotate([90 + 30 / 60, -35 - 50 / 60]);
		
	var path = d3.geo.path()
		.projection(projection);
		
	var quantize = d3.scale.threshold()
			.domain([-999,-499,-99,-1,1,99,499,999])
			.range(["q0-9","q1-9","q2-9","q3-9","q4-9","q5-9","q6-9","q7-9","q8-9"]);

	d3.csv("data/final.csv", function(data) {
			
	d3.json("data/mo_counties.topojson", function(stl) {
		
		var formatVotes = d3.format(",0");
		
		var no1 = d3.sum(data, function(d) { return +d.no1 })
		var no5 = d3.sum(data, function(d) { return +d.no5 })
		var no7 = d3.sum(data, function(d) { return +d.no7 })
		var no8 = d3.sum(data, function(d) { return +d.no8 })
		var no9 = d3.sum(data, function(d) { return +d.no9 })
		var yes1 = d3.sum(data, function(d) { return +d.yes1 })
		var yes5 = d3.sum(data, function(d) { return +d.yes5 })
		var yes7 = d3.sum(data, function(d) { return +d.yes7 })
		var yes8 = d3.sum(data, function(d) { return +d.yes8 })
		var yes9 = d3.sum(data, function(d) { return +d.yes9 })
		
		d3.select(".no1")
		.html(formatVotes(no1));
		d3.select(".no5")
		.html(formatVotes(no5));
		d3.select(".no7")
		.html(formatVotes(no7));
		d3.select(".no8")
		.html(formatVotes(no8));
		d3.select(".no9")
		.html(formatVotes(no9));
		d3.select(".yes1")
		.html(formatVotes(yes1));
		d3.select(".yes5")
		.html(formatVotes(yes5));
		d3.select(".yes7")
		.html(formatVotes(yes7));
		d3.select(".yes8")
		.html(formatVotes(yes8));
		d3.select(".yes9")
		.html(formatVotes(yes9));
			
		var counties = topojson.feature(stl, stl.objects.mo_counties_plus_KC)

		for (var i = 0; i < data.length; i++) {
			var dataId = data[i].id;
			var yesVotes1 = parseFloat(data[i].yes1)
			var noVotes1 = parseFloat(data[i].no1)
			var yesVotes5 = parseFloat(data[i].yes5)
			var noVotes5 = parseFloat(data[i].no5)
			var yesVotes7 = parseFloat(data[i].yes7)
			var noVotes7 = parseFloat(data[i].no7)
			var yesVotes8 = parseFloat(data[i].yes8)
			var noVotes8 = parseFloat(data[i].no8)
			var yesVotes9 = parseFloat(data[i].yes9)
			var noVotes9 = parseFloat(data[i].no9)
			var amend1 = yesVotes1 - noVotes1;
			var amend5 = yesVotes5 - noVotes5;
			var amend7 = yesVotes7 - noVotes7;
			var amend8 = yesVotes8 - noVotes8;
			var amend9 = yesVotes9 - noVotes9;
			for (var j = 0; j < counties.features.length; j++) {
				var stlCounty = counties.features[j].properties.COUNTYFP;
				if (dataId == stlCounty) {
					counties.features[j].properties.amend1 = amend1;
					counties.features[j].properties.amend5 = amend5;
					counties.features[j].properties.amend7 = amend7;
					counties.features[j].properties.amend8 = amend8;
					counties.features[j].properties.amend9 = amend9;
					break;
				}
			}
		}
		
		projection
		.scale(1)
		.translate([0,0]);
		
		var b = path.bounds(counties),
			s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
			t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];
			
			projection
			.scale(s)
			.translate(t);
		
		    svg1.selectAll("path")
		        .data(counties.features)
		      .enter().append("path")
		        .attr("class", function(d) { return quantize(d.properties.amend1); })
		        .attr("d", path)
		      .append("title")
		        .text(function(d) { return d.properties.NAME + ": " + formatVotes(d.properties.amend1) + " votes"; });
			
			svg1.append("path")
				.datum(topojson.mesh(stl, stl.objects.mo_counties_plus_KC, function(a, b) { return a !== b; }))
				.attr("class", "county-border")
				.attr("d", path);

			svg1.append("path")
				.datum(topojson.mesh(stl, stl.objects.mo_counties_plus_KC, function(a, b) { return a === b; }))
				.attr("class", "state-border")
				.attr("d", path);
				
				svg1.append("text")
				.text("K.C.")
				.attr("x", "55")
				.attr("y", "250");
				
				svg5.append("text")
				.text("K.C.")
				.attr("x", "55")
				.attr("y", "250");
				
				svg7.append("text")
				.text("K.C.")
				.attr("x", "55")
				.attr("y", "250");
				
				svg8.append("text")
				.text("K.C.")
				.attr("x", "55")
				.attr("y", "250");
				
				svg9.append("text")
				.text("K.C.")
				.attr("x", "55")
				.attr("y", "250");

			    svg5.selectAll("path")
			        .data(counties.features)
			      .enter().append("path")
			        .attr("class", function(d) { return quantize(d.properties.amend5); })
			        .attr("d", path)
			      .append("title")
  		        .text(function(d) { return d.properties.NAME + ": " + formatVotes(d.properties.amend5) + " votes"; });
			
				svg5.append("path")
					.datum(topojson.mesh(stl, stl.objects.mo_counties_plus_KC, function(a, b) { return a !== b; }))
					.attr("class", "county-border")
					.attr("d", path);

				svg5.append("path")
					.datum(topojson.mesh(stl, stl.objects.mo_counties_plus_KC, function(a, b) { return a === b; }))
					.attr("class", "state-border")
					.attr("d", path);

				    svg7.selectAll("path")
				        .data(counties.features)
				      .enter().append("path")
				        .attr("class", function(d) { return quantize(d.properties.amend7); })
				        .attr("d", path)
				      .append("title")
	  		        .text(function(d) { return d.properties.NAME + ": " + formatVotes(d.properties.amend7) + " votes"; });
			
					svg7.append("path")
						.datum(topojson.mesh(stl, stl.objects.mo_counties_plus_KC, function(a, b) { return a !== b; }))
						.attr("class", "county-border")
						.attr("d", path);

					svg7.append("path")
						.datum(topojson.mesh(stl, stl.objects.mo_counties_plus_KC, function(a, b) { return a === b; }))
						.attr("class", "state-border")
						.attr("d", path);
						
					    svg8.selectAll("path")
					        .data(counties.features)
					      .enter().append("path")
					        .attr("class", function(d) { return quantize(d.properties.amend8); })
					        .attr("d", path)
					      .append("title")
		  		        .text(function(d) { return d.properties.NAME + ": " + formatVotes(d.properties.amend8) + " votes"; });
			
						svg8.append("path")
							.datum(topojson.mesh(stl, stl.objects.mo_counties_plus_KC, function(a, b) { return a !== b; }))
							.attr("class", "county-border")
							.attr("d", path);

						svg8.append("path")
							.datum(topojson.mesh(stl, stl.objects.mo_counties_plus_KC, function(a, b) { return a === b; }))
							.attr("class", "state-border")
							.attr("d", path);
							
						    svg9.selectAll("path")
						        .data(counties.features)
						      .enter().append("path")
						        .attr("class", function(d) { return quantize(d.properties.amend9); })
						        .attr("d", path)
						      .append("title")
			  		        .text(function(d) { return d.properties.NAME + ": " + formatVotes(d.properties.amend9) + " votes"; });
			
							svg9.append("path")
								.datum(topojson.mesh(stl, stl.objects.mo_counties_plus_KC, function(a, b) { return a !== b; }))
								.attr("class", "county-border")
								.attr("d", path);

							svg9.append("path")
								.datum(topojson.mesh(stl, stl.objects.mo_counties_plus_KC, function(a, b) { return a === b; }))
								.attr("class", "state-border")
								.attr("d", path);
			});
		});
		
		
		var piewidth = 250,
		    pieheight = 250,
		    radius = Math.min(piewidth, pieheight) / 2;

		var demcolor = d3.scale.ordinal()
		    .range(["#006c8e","#358fb3","#55b7d9"]);
			
			var repcolor = d3.scale.ordinal()
			    .range(["#cc203b","#CC7684"]);

		var arc = d3.svg.arc()
		    .outerRadius(radius - 10)
		    .innerRadius(0);

		var pie = d3.layout.pie()
		    .sort(null)
		    .value(function(d) { return d.votes; });

		var svg = d3.select(".stldem").append("svg")
		    .attr("width", piewidth)
		    .attr("height", pieheight)
		  .append("g")
		    .attr("transform", "translate(" + piewidth / 2 + "," + pieheight / 2 + ")");

		d3.csv("data/demexec.csv", function(error, demexec) {

		  demexec.forEach(function(d) {
		    d.votes = +d.votes;
		  });

		  var g = svg.selectAll(".arc")
		      .data(pie(demexec))
		    .enter().append("g")
		      .attr("class", "arc");

		  g.append("path")
		      .attr("d", arc)
		      .style("fill", function(d) { return demcolor(d.data.name); });

		  g.append("text")
		      .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
		      .attr("dy", ".35em")
		      .style("text-anchor", "middle")
			  .attr("class", "candidates")
		      .text(function(d) { return d.data.name; });

		});

		var svg2 = d3.select(".stlrep").append("svg")
		    .attr("width", piewidth)
		    .attr("height", pieheight)
		  .append("g")
		    .attr("transform", "translate(" + piewidth / 2 + "," + pieheight / 2 + ")");

		d3.csv("data/repexec.csv", function(error, repexec) {

		  repexec.forEach(function(d) {
		    d.votes = +d.votes;
		  });

		  var g = svg2.selectAll(".arc")
		      .data(pie(repexec))
		    .enter().append("g")
		      .attr("class", "arc");

		  g.append("path")
		      .attr("d", arc)
		      .style("fill", function(d) { return repcolor(d.data.name); });

		  g.append("text")
		      .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
		      .attr("dy", ".35em")
		      .style("text-anchor", "middle")
			  .attr("class", "candidates")
		      .text(function(d) { return d.data.name; });

		});

			
	</script>

    <script src="js/lib/jquery.js" type="text/javascript"></script>
    <script src="js/lib/pym.js" type="text/javascript"></script>
    <script src="js/graphic.js" type="text/javascript"></script>
</body>
</html>
